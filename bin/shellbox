#!/bin/bash

SHELLBOX_HOME="/usr/local/shellbox"
BIN_DIR="$SHELLBOX_HOME/bin"
LOG_DIR="$SHELLBOX_HOME/log"
CONTAINERS_DIR="$SHELLBOX_HOME/containers"
UNINSTALL_SCRIPT="$SHELLBOX_HOME/lib/uninstall.sh"
DEFAULT_IMAGE="gcr.io/distroless/base-debian12:debug-nonroot"

# åˆæœŸåŒ–
init_shellbox() {
    echo "Initializing ShellBox..."
    mkdir -p "$BIN_DIR" "$LOG_DIR" "$CONTAINERS_DIR"
    echo "âœ… ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸã€‚"
}

# ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
install_command() {
    local CMD="$1"
    local IMAGE="${2:-$DEFAULT_IMAGE}"
    local CMD_DIR="$CONTAINERS_DIR/$CMD"
    local SCRIPT_PATH="$BIN_DIR/$CMD"

    echo "Installing command: $CMD"
    echo "Using base image: $IMAGE"

    mkdir -p "$CMD_DIR"

    # Dockerfileç”Ÿæˆ
    cat > "$CMD_DIR/Dockerfile" <<EOF
FROM $IMAGE
ENTRYPOINT ["$CMD"]
EOF

    # ã‚³ãƒ³ãƒ†ãƒŠãƒ“ãƒ«ãƒ‰
    podman build -t "shellbox_$CMD" "$CMD_DIR"

    # å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆ
    cat > "$SCRIPT_PATH" <<EOF
#!/bin/bash
CMD_IMAGE="shellbox_$CMD"

if ! podman run --rm -v "\$PWD":/mnt "\$CMD_IMAGE" /mnt "\$@"; then
    echo "âŒ ShellBox å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒã‚¦ãƒ³ãƒˆã«å¤±æ•—ã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚" >&2
    echo "ğŸ’¡ macOSç’°å¢ƒã§ã¯ \$HOME é…ä¸‹ã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚" >&2
    exit 1
fi
EOF

    chmod +x "$SCRIPT_PATH"
    echo "âœ… ã‚³ãƒãƒ³ãƒ‰ '$CMD' ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ãŸã€‚"
}

# ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
uninstall_shellbox() {
    if [ -x "$UNINSTALL_SCRIPT" ]; then
        bash "$UNINSTALL_SCRIPT"
    else
        echo "âš  uninstall.sh ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $UNINSTALL_SCRIPT"
        echo "æ‰‹å‹•ã§ $SHELLBOX_HOME ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚"
    fi
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
case "${1:-}" in
    init)
        init_shellbox
        ;;
    install)
        if [ -z "${2:-}" ]; then
            echo "Usage: shellbox install {command_name} [base_container_image]"
            exit 1
        fi
        install_command "$2" "${3:-}"
        ;;
    uninstall)
        uninstall_shellbox
        ;;
    *)
        echo "Usage: shellbox {init|install|uninstall}"
        exit 1
        ;;
esac
