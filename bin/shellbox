#!/bin/bash
set -euo pipefail

SHELLBOX_HOME="/usr/local/shellbox"
BIN_DIR="$SHELLBOX_HOME/bin"
LOG_DIR="$SHELLBOX_HOME/log"
CONTAINERS_DIR="$SHELLBOX_HOME/containers"
LIB_DIR="$SHELLBOX_HOME/lib"
TEMPLATE_PATH="$LIB_DIR/runsh_template.sh"
UNINSTALL_SCRIPT="$LIB_DIR/uninstall.sh"
DEFAULT_IMAGE="gcr.io/distroless/base-debian12:debug-nonroot"
VERSION_FILE="$SHELLBOX_HOME/VERSION"

# åˆæœŸåŒ–
init_shellbox() {
    echo "Initializing ShellBox..."
    mkdir -p "$BIN_DIR" "$LOG_DIR" "$CONTAINERS_DIR"
    echo "âœ… ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸã€‚"
}

# ShellBoxã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
install_command() {
    local CMD_NAME="$1"
    local ENTRYPOINT_CMD="$2"
    local IMAGE="$3"
    local FORCE="${4:-}"

    local CMD_DIR="$CONTAINERS_DIR/$CMD_NAME"
    local SCRIPT_PATH="$BIN_DIR/$CMD_NAME"
    local CMD_IMAGE="shellbox_$CMD_NAME"

    local MOUNTS_TEMPLATE="$LIB_DIR/mounts_template.conf"
    local MOUNTS_CONF_PATH="$CMD_DIR/mounts.conf"
    local DOCKERFILE_TEMPLATE="$LIB_DIR/dockerfile_template.Dockerfile"
    local DOCKERFILE_PATH="$CMD_DIR/Dockerfile"

    echo "Installing command: $CMD_NAME"
    echo "Using base image: $IMAGE"
    echo "Container ENTRYPOINT: $ENTRYPOINT_CMD"

    if [[ "$FORCE" != "force" ]]; then
        if ! podman run --rm "$IMAGE" sh -c "command -v $ENTRYPOINT_CMD" > /dev/null 2>&1; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: ã‚¤ãƒ¡ãƒ¼ã‚¸ '$IMAGE' ã«ã‚³ãƒãƒ³ãƒ‰ '$ENTRYPOINT_CMD' ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚"
            echo "ğŸ’¡ busyboxãªã©ã§æ˜ç¤ºçš„ã«ç¶šè¡Œã™ã‚‹ã«ã¯: shellbox install ... --force"
            return 1
        fi
    else
        echo "âš  --force æŒ‡å®šã«ã‚ˆã‚Š ENTRYPOINT å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚"
    fi

    mkdir -p "$CMD_DIR"

    # install Dockerfile and build-image
    if [[ ! -f "$DOCKERFILE_TEMPLATE" ]]; then
        echo "âŒ ã‚¨ãƒ©ãƒ¼: Dockerfile ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $DOCKERFILE_TEMPLATE"
        return 1
    fi

    sed -e "s|{{IMAGE}}|$IMAGE|g" \
        -e "s|{{ENTRYPOINT}}|$ENTRYPOINT_CMD|g" \
        "$DOCKERFILE_TEMPLATE" > "$DOCKERFILE_PATH"

    podman build -t "$CMD_IMAGE" "$CMD_DIR"

    # install runsh-script
    if [[ ! -f "$TEMPLATE_PATH" ]]; then
        echo "âŒ ã‚¨ãƒ©ãƒ¼: å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $TEMPLATE_PATH"
        return 1
    fi

    sed -e "s|{{CMD_IMAGE}}|$CMD_IMAGE|g" \
        -e "s|{{CMD_NAME}}|$CMD_NAME|g" \
        "$TEMPLATE_PATH" > "$SCRIPT_PATH"
    chmod +x "$SCRIPT_PATH"

    # install mounts.conf
    if [[ -f "$MOUNTS_TEMPLATE" ]]; then
        cp "$MOUNTS_TEMPLATE" "$MOUNTS_CONF_PATH"
        echo "ğŸªµ mounts.conf ã‚’ä½œæˆã—ã¾ã—ãŸ: $MOUNTS_CONF_PATH"
    else
        echo "âš ï¸  mounts_template.conf ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $MOUNTS_TEMPLATE"
    fi

    echo "âœ… ã‚³ãƒãƒ³ãƒ‰ '$CMD_NAME' ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ãŸã€‚"
}

# ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
uninstall_shellbox() {
    if [ -x "$UNINSTALL_SCRIPT" ]; then
        bash "$UNINSTALL_SCRIPT"
    else
        echo "âš  uninstall.sh ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $UNINSTALL_SCRIPT"
        echo "æ‰‹å‹•ã§ $SHELLBOX_HOME ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚"
    fi
}

# ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£æ©Ÿèƒ½ç¾¤
edit_command() {
    local CMD="$1"
    local TARGET="$BIN_DIR/$CMD"
    [[ -f "$TARGET" ]] && "${EDITOR:-vi}" "$TARGET" || echo "âŒ $CMD ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚"
}

# ShellBoxã‚³ãƒãƒ³ãƒ‰ä¸€è¦§è¡¨ç¤º
list_commands() {
    echo "ğŸ“¦ ShellBoxã‚³ãƒãƒ³ãƒ‰ä¸€è¦§:"
    find "$BIN_DIR" -type f -exec basename {} \; | sort
}

# ShellBoxã‚³ãƒãƒ³ãƒ‰å‰Šé™¤
remove_command() {
    local CMD="$1"
    rm -f "$BIN_DIR/$CMD"
    rm -rf "$CONTAINERS_DIR/$CMD"
    echo "ğŸ—‘ï¸ '$CMD' ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚"
}

# ShellBoxãƒ‘ã‚¹è¡¨ç¤º
show_paths() {
    echo "ShellBoxæ§‹æˆãƒ‘ã‚¹:"
    echo "  BIN_DIR:         $BIN_DIR"
    echo "  LOG_DIR:         $LOG_DIR"
    echo "  CONTAINERS_DIR:  $CONTAINERS_DIR"
    echo "  LIB_DIR:         $LIB_DIR"
}

# ShellBoxãƒã‚¦ãƒ³ãƒˆè¨­å®šç·¨é›†
edit_mounts() {
    local CMD_NAME="$1"
    local MOUNTS_PATH="$CONTAINERS_DIR/$CMD_NAME/mounts.conf"
    local TEMPLATE="$LIB_DIR/mounts_template.conf"

    if [[ ! -d "$CONTAINERS_DIR/$CMD_NAME" ]]; then
        echo "âŒ '$CMD_NAME' ã¯ã¾ã ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
        return 1
    fi

    if [[ ! -f "$MOUNTS_PATH" && -f "$TEMPLATE" ]]; then
        cp "$TEMPLATE" "$MOUNTS_PATH"
        echo "ğŸ“„ mounts.conf ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ä½œæˆã—ã¾ã—ãŸã€‚"
    fi

    local EDITOR_CMD="${EDITOR:-vi}"
    $EDITOR_CMD "$MOUNTS_PATH"
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
case "${1:-}" in
    --version)
        [[ -f "$VERSION_FILE" ]] && cat "$VERSION_FILE" || echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        ;;
    init) init_shellbox ;;
    install)
        if [ -z "${2:-}" ] || [ -z "${3:-}" ]; then
            echo "Usage: shellbox install <sb_command_name> <entrypoint_cmd> [base_image] (optional)"
            echo "       Add -f or --force to skip entrypoint existence check"
            exit 1
        fi
        FORCE_FLAG=""
        if [[ "${4:-}" == "-f" || "${4:-}" == "--force" ]]; then
            FORCE_FLAG="force"
            install_command "$2" "$3" "$DEFAULT_IMAGE" "$FORCE_FLAG"
        elif [[ "${5:-}" == "-f" || "${5:-}" == "--force" ]]; then
            FORCE_FLAG="force"
            install_command "$2" "$3" "$4" "$FORCE_FLAG"
        else
            install_command "$2" "$3" "${4:-$DEFAULT_IMAGE}" "$FORCE_FLAG"
        fi
        ;;
    edit-mounts)
        shift
        edit_mounts "$@"
        ;;
    uninstall) uninstall_shellbox ;;
    -e) edit_command "$2" ;;
    -l) list_commands ;;
    -r) remove_command "$2" ;;
    --path) show_paths ;;
    *)
        echo "Usage: shellbox [init|install|uninstall|---edit-mounts <cmd>|-version|-e <cmd>|-l|-r <cmd>|--path]"
        exit 1
        ;;
esac
